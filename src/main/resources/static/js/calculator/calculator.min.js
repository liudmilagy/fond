import{view_header,main_padding,main_body_width,numberFormatWithoutDecimal,changeContentView,view_header_left,collapsedSideBarWidth}from"../general.min.js";import{calculator_with_schedule,calculateDifferentiated}from"./calculator_with_schedule.min.js";export function calculator(e){var t=e.reduce((e,t)=>(e[t.id]=t,e),{}),i=webix.ajax().sync().get("get_key_rate"),a=JSON.parse(i.responseText),l=e[0],o=!e[0].hiddenWithDeposit,r=e[0].hiddenWithDeposit||e[0].hiddenWithoutDeposit,n=o?e[0].minAmountWithDeposit:e[0].minAmountWithoutDeposit,d=o?e[0].maxAmountWithDeposit:e[0].maxAmountWithoutDeposit,u=e[0].limitation,s=getRate(l,o,a),m={rows:[{view:"richselect",id:"programRichselectId",label:"Программа",labelPosition:"top",name:"programRichselect",options:e,value:l,css:"fond",bottomPadding:10,on:{onChange:()=>{setCalculatorValues(t[$$("programRichselectId").getValue()])}}},{view:"switch",name:"deposit",id:"depositId",onLabel:"С залогом",offLabel:"Без залога",value:o,disabled:r,bottomPadding:10,on:{onChange:()=>{setCalculatorValues(t[$$("programRichselectId").getValue()])}}},{view:"slider",name:"amountSlider",id:"amountSliderId",label:"Размер займа",labelPosition:"top",value:n,step:1e4,min:n,max:d,bottomPadding:10,title:e=>webix.i18n.numberFormat(e.value),css:"calculator_result",on:{onChange:function(){setCalculatorResultValues(t[$$("programRichselectId").getValue()],a)},onSliderDrag:function(){setCalculatorResultValues(t[$$("programRichselectId").getValue()],a)}}},{view:"slider",id:"timeSliderId",label:"Срок займа",labelPosition:"top",value:u,step:1,min:6,max:u,name:"slider2",title:webix.template("#value# мес."),css:"calculator_result",bottomPadding:10,on:{onChange:function(){setCalculatorResultValues(t[$$("programRichselectId").getValue()],a)},onSliderDrag:function(){setCalculatorResultValues(t[$$("programRichselectId").getValue()],a)}}}]},c={autoheight:!0,margin:20,rows:[{name:"rate",cols:[{template:"Процентная ставка, %",autoheight:!0,borderless:!0,align:"left",css:"calculator_result"},{gravity:.1},{view:"label",id:"rateLabelId",label:s,autoheight:!0,borderless:!0,align:"right",css:"calculator_result"},{view:"text",id:"rateValueId",value:s,hidden:!0}]},{},{cols:[{template:"Ежемесячный платёж, руб.",autoheight:!0,borderless:!0,align:"left",css:"calculator_result"},{gravity:.1},{view:"label",id:"monthlyPaymentId",label:getMonthlyPaymentDifferentiated(s,n,u),autoheight:!0,borderless:!0,align:"right",css:"calculator_result"}]},{},{cols:[{template:"Переплата",autoheight:!0,borderless:!0,align:"left",css:"calculator_result"},{gravity:.1},{id:"overPaymentId",view:"label",label:getOverPaymentDifferentiated(s,n,u),autoheight:!0,borderless:!0,align:"right",css:"calculator_result"}]},{},{autoheight:!0,template:'<div class="schedule_link">Перейти к графику платежей</div>',borderless:!0,align:"left",css:"calculator_template_link",onClick:{schedule_link:()=>{var e=$$("rateValueId").getValue(),t=$$("timeSliderId").getValue(),i=$$("amountSliderId").getValue(),a=!0;document.body.clientWidth<main_body_width&&(a=!1),webix.ui({id:"content",rows:[webix.copy(calculator_with_schedule(a))]},$$("content")),$$("amountId").setValue(i),$$("limitationId").setValue(t),$$("rateId").setValue(e),$$("typeId").setValue(2),calculateDifferentiated(),$$("calculatorResultId").resize()}}}]},h=main_body_width;return document.body.clientWidth<main_body_width?(h=document.body.clientWidth-collapsedSideBarWidth,{borderless:!0,margin:3,gravity:0,padding:main_padding,width:h,rows:[view_header_left("Калькулятор"),{borderless:!0,rows:[m,c]}]}):{borderless:!0,margin:3,gravity:0,padding:main_padding,width:h,rows:[view_header_left("Калькулятор"),{borderless:!0,margin:30,cols:[m,c]}]}}function getRate(e,t,i){return t?e.hasKeyRateWithDeposit?e.coefKeyRateWithDeposit*i:e.interestRateWithDeposit:e.hasKeyRateWithoutDeposit?e.coefKeyRateWithoutDeposit*i:e.interestRateWithoutDeposit}function getMonthlyPayment(e,t,i){var a=.01*e/12,l=(a+a/(Math.pow(1+a,i)-1))*t;return webix.Number.format(l,{groupSize:3,decimalSize:2,decimalDelimiter:".",groupDelimiter:" "})}function getOverPayment(e,t,i){var a=.01*e/12,l=(a+a/(Math.pow(1+a,i)-1))*t*i-t;return webix.Number.format(l,{groupSize:3,decimalSize:2,decimalDelimiter:".",groupDelimiter:" "})}function getMonthlyPaymentDifferentiated(e,t,i){var a=t/i*(1+e*(i+1)*31/73e3);return webix.Number.format(a,{groupSize:3,decimalSize:2,decimalDelimiter:".",groupDelimiter:" "})}function getOverPaymentDifferentiated(e,t,i){var a=t*e*(i+1)*31/73e3;return webix.Number.format(a,{groupSize:3,decimalSize:2,decimalDelimiter:".",groupDelimiter:" "})}function setCalculatorResultValues(e,t){var i=getRate(e,$$("depositId").getValue(),t);$$("rateLabelId").setValue(i),$$("rateValueId").setValue(i),$$("monthlyPaymentId").setValue(getMonthlyPaymentDifferentiated(i,$$("amountSliderId").getValue(),$$("timeSliderId").getValue())),$$("overPaymentId").setValue(getOverPaymentDifferentiated(i,$$("amountSliderId").getValue(),$$("timeSliderId").getValue()))}export function clickOnProductButton(e){$$("programRichselectId").setValue(e),setCalculatorValues(e)}function setCalculatorValues(e){var t=getNewDepositValue(e);$$("depositId").setValue(t),e.hiddenWithDeposit||e.hiddenWithoutDeposit?$$("depositId").disable():$$("depositId").enable(),setMinMaxAmountValues(e,t),setLimitation(e);var i=webix.ajax().sync().get("get_key_rate");setCalculatorResultValues(e,JSON.parse(i.responseText))}function setMinMaxAmountValues(e,t){var i=$$("amountSliderId").getValue(),a=t?e.minAmountWithDeposit:e.minAmountWithoutDeposit,l=t?e.maxAmountWithDeposit:e.maxAmountWithoutDeposit;$$("amountSliderId").config.min=a,$$("amountSliderId").config.max=l,i>l?$$("amountSliderId").setValue(l):i<a&&$$("amountSliderId").setValue(a),$$("amountSliderId").refresh()}function setLimitation(e){$$("timeSliderId").config.max=e.limitation,$$("timeSliderId").getValue()>e.limitation&&$$("timeSliderId").setValue(e.limitation),$$("timeSliderId").refresh()}function getNewDepositValue(e){return 0==$$("depositId").getValue()||0==$$("depositId").getValue()?!!e.hiddenWithoutDeposit:!e.hiddenWithDeposit}